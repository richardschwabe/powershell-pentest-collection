# Define file paths
$inputFilePath = "target_ips.txt"
$outputFilePath = "smb_shares_results.txt"

# Function to check SMB shares for a given target IP
function CheckSmbShares($targetIp, $username, $password) {
    try {
        # Create a credential object
        $credential = New-Object System.Management.Automation.PSCredential -ArgumentList @($username, (ConvertTo-SecureString $password -AsPlainText -Force))

        # Attempt to access SMB shares with provided credentials
        $smbShares = Get-WmiObject -Class Win32_Share -ComputerName $targetIp -Credential $credential -ErrorAction Stop

        if ($smbShares) {
            Write-Host "SMB shares on $targetIp (using provided credentials):"
            foreach ($share in $smbShares) {
                Write-Host "   - $($share.Name)"
                Add-Content -Path $outputFilePath -Value "{$targetIp}: $($share.Name) (using provided credentials)"
            }
        }
        else {
            Write-Host "No SMB shares found on $targetIp with provided credentials."
            Add-Content -Path $outputFilePath -Value "No SMB shares found on $targetIp with provided credentials."
        }
    }
    catch {
        Write-Host "Error accessing SMB shares on $targetIp with provided credentials: $_"
        Add-Content -Path $outputFilePath -Value "Error accessing SMB shares on $targetIp with provided credentials: $_"
    }
}

# Function to check for anonymous SMB shares on a given target IP
function CheckAnonymousSmbShares($targetIp) {
    try {
        # Attempt to access SMB shares without credentials
        $anonymousSmbShares = Get-WmiObject -Class Win32_Share -ComputerName $targetIp -ErrorAction Stop

        if ($anonymousSmbShares) {
            Write-Host "Anonymous SMB shares on {$targetIp}:"
            foreach ($share in $anonymousSmbShares) {
                Write-Host "   - $($share.Name)"
                Add-Content -Path $outputFilePath -Value "{$targetIp}: $($share.Name) (anonymous)"
            }
        }
        else {
            Write-Host "No anonymous SMB shares found on $targetIp."
            Add-Content -Path $outputFilePath -Value "No anonymous SMB shares found on $targetIp."
        }
    }
    catch {
        Write-Host "Error accessing anonymous SMB shares on {$targetIp}: $_"
        Add-Content -Path $outputFilePath -Value "Error accessing anonymous SMB shares on {$targetIp}: $_"
    }
}

# Read target IPs from the input file
$targetIps = Get-Content -Path $inputFilePath

# Provide Active Directory credentials
$adUsername = Read-Host -Prompt "Enter Active Directory username"
$adPassword = Read-Host -Prompt "Enter Active Directory password" -AsSecureString

# Loop through each target IP and check for SMB shares
foreach ($ip in $targetIps) {
    Write-Host "Checking SMB shares on $ip..."

    # Check with provided credentials
    CheckSmbShares -targetIp $ip -username $adUsername -password $adPassword

    # Check for anonymous shares if no credentials provided
    if (-not $adUsername -or -not $adPassword) {
        CheckAnonymousSmbShares -targetIp $ip
    }

    Write-Host ""
}

Write-Host "SMB shares check complete. Results saved to $outputFilePath."